---
phase: 01-security-hardening
plan: 03
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - app/config.py
  - app/api/v1/webhooks.py
autonomous: true

must_haves:
  truths:
    - "Sentinel webhook rejects requests without valid X-Sentinel-Auth-Token header in production"
    - "Splunk webhook rejects requests without valid Authorization: Splunk <token> header in production"
    - "Both webhooks work without secrets in development mode (with warning log)"
    - "Invalid signatures return 401 Unauthorized"
  artifacts:
    - path: "app/config.py"
      provides: "Webhook secret settings"
      contains: "sentinel_webhook_secret"
    - path: "app/api/v1/webhooks.py"
      provides: "Signature verification for Sentinel and Splunk"
      contains: "X-Sentinel-Auth-Token"
  key_links:
    - from: "app/api/v1/webhooks.py"
      to: "app/config.py"
      via: "reads settings.sentinel_webhook_secret"
      pattern: "settings\\.sentinel_webhook_secret"
    - from: "app/api/v1/webhooks.py"
      to: "app/config.py"
      via: "reads settings.splunk_webhook_secret"
      pattern: "settings\\.splunk_webhook_secret"
---

<objective>
Implement webhook signature verification for Azure Sentinel and Splunk (SEC-01, SEC-02).

Purpose: Prevent unauthorized/spoofed alert submissions to the Sentinel and Splunk webhook endpoints.
Output: Both webhook endpoints validate authentication headers, rejecting invalid requests with 401.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-security-hardening/01-RESEARCH.md
@.planning/phases/01-security-hardening/01-01-SUMMARY.md

# Existing files to modify
@app/config.py
@app/api/v1/webhooks.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add webhook secret configuration</name>
  <files>app/config.py</files>
  <action>
Note: Plan 01 already modified config.py. Build on those changes.

Add two new webhook secret settings after the existing `elastic_siem_webhook_secret` field:

```python
# Azure Sentinel
sentinel_webhook_secret: Optional[str] = Field(
    default=None,
    alias="SENTINEL_WEBHOOK_SECRET"
)

# Splunk
splunk_webhook_secret: Optional[str] = Field(
    default=None,
    alias="SPLUNK_WEBHOOK_SECRET"
)
```

These should be placed in the "Elastic SIEM" section or create a new "# Webhook Secrets" comment section.

Also verify that the startup validation (if Plan 01 is applied) could optionally warn about missing webhook secrets in production. This is NOT a blocker - just a nice-to-have warning.
  </action>
  <verify>
```bash
python -c "
from app.config import settings
print(f'sentinel_webhook_secret: {settings.sentinel_webhook_secret}')
print(f'splunk_webhook_secret: {settings.splunk_webhook_secret}')
print('Webhook secret settings loaded')
"
```
  </verify>
  <done>
sentinel_webhook_secret and splunk_webhook_secret fields added to Settings class. Both default to None and can be set via environment variables.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add signature verification to Sentinel and Splunk webhooks</name>
  <files>app/api/v1/webhooks.py</files>
  <action>
**Update azure_sentinel_webhook endpoint:**

1. Add header parameter:
   ```python
   x_sentinel_auth: str = Header(None, alias="X-Sentinel-Auth-Token"),
   ```

2. Add verification logic at the start of the function, after getting the request body:
   ```python
   body = await request.body()
   payload = await request.json()

   # Verify authentication
   if settings.sentinel_webhook_secret:
       if not x_sentinel_auth or not hmac.compare_digest(
           x_sentinel_auth, settings.sentinel_webhook_secret
       ):
           logger.warning("Invalid or missing Sentinel webhook authentication")
           raise HTTPException(
               status_code=status.HTTP_401_UNAUTHORIZED,
               detail="Invalid webhook authentication"
           )
   elif settings.env == "production":
       logger.error("Sentinel webhook secret not configured in production")
       raise HTTPException(
           status_code=status.HTTP_403_FORBIDDEN,
           detail="Webhook authentication required in production"
       )
   else:
       logger.warning("Sentinel webhook secret not configured - skipping auth in dev mode")
   ```

**Update splunk_webhook endpoint:**

1. Add header parameter:
   ```python
   authorization: str = Header(None),
   ```

2. Add verification logic at the start, after getting request body:
   ```python
   body = await request.body()
   payload = await request.json()

   # Verify Splunk HEC-style authentication
   if settings.splunk_webhook_secret:
       expected_auth = f"Splunk {settings.splunk_webhook_secret}"
       if not authorization or not hmac.compare_digest(
           authorization, expected_auth
       ):
           logger.warning("Invalid or missing Splunk webhook authentication")
           raise HTTPException(
               status_code=status.HTTP_401_UNAUTHORIZED,
               detail="Invalid Splunk authentication token"
           )
   elif settings.env == "production":
       logger.error("Splunk webhook secret not configured in production")
       raise HTTPException(
           status_code=status.HTTP_403_FORBIDDEN,
           detail="Webhook authentication required in production"
       )
   else:
       logger.warning("Splunk webhook secret not configured - skipping auth in dev mode")
   ```

**Important:** Use `hmac.compare_digest()` for timing-attack-safe comparison (already imported at top of file).
  </action>
  <verify>
```bash
python -c "
import inspect
from app.api.v1.webhooks import azure_sentinel_webhook, splunk_webhook

# Check Sentinel has auth header param
sig = inspect.signature(azure_sentinel_webhook)
params = list(sig.parameters.keys())
print(f'Sentinel params: {params}')
assert 'x_sentinel_auth' in params, 'Missing x_sentinel_auth param'

# Check Splunk has auth header param
sig = inspect.signature(splunk_webhook)
params = list(sig.parameters.keys())
print(f'Splunk params: {params}')
assert 'authorization' in params, 'Missing authorization param'

print('Both webhook endpoints have auth parameters')
"
```
  </verify>
  <done>
Sentinel webhook validates X-Sentinel-Auth-Token header against SENTINEL_WEBHOOK_SECRET. Splunk webhook validates Authorization: Splunk <token> header against SPLUNK_WEBHOOK_SECRET. Both reject unauthenticated requests in production, allow in development with warning.
  </done>
</task>

</tasks>

<verification>
1. App starts: `python -c "from app.main import app"`
2. Sentinel endpoint signature includes x_sentinel_auth parameter
3. Splunk endpoint signature includes authorization parameter
4. With secret configured, invalid auth returns 401
5. Without secret in dev mode, requests pass with warning log
</verification>

<success_criteria>
- SEC-01: Sentinel webhook requires X-Sentinel-Auth-Token header when SENTINEL_WEBHOOK_SECRET is set
- SEC-01: Sentinel webhook returns 401 for invalid/missing token
- SEC-01: Sentinel webhook returns 403 in production if secret not configured
- SEC-02: Splunk webhook requires Authorization: Splunk <token> header when SPLUNK_WEBHOOK_SECRET is set
- SEC-02: Splunk webhook returns 401 for invalid/missing token
- SEC-02: Splunk webhook returns 403 in production if secret not configured
- Both use timing-safe comparison (hmac.compare_digest)
</success_criteria>

<output>
After completion, create `.planning/phases/01-security-hardening/01-03-SUMMARY.md`
</output>
