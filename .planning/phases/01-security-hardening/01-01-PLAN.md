---
phase: 01-security-hardening
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/config.py
  - app/main.py
  - app/core/startup.py
autonomous: true

must_haves:
  truths:
    - "Application fails to start if SECRET_KEY contains 'changeme' in production"
    - "Application fails to start if database password contains 'changeme' in production"
    - "CORS rejects requests with non-whitelisted methods"
    - "CORS rejects requests with non-whitelisted headers"
  artifacts:
    - path: "app/core/startup.py"
      provides: "Production configuration validation"
      exports: ["validate_production_config"]
    - path: "app/config.py"
      provides: "CORS method and header settings"
      contains: "cors_allowed_methods"
    - path: "app/main.py"
      provides: "CORS middleware with explicit configuration"
      contains: "allow_methods="
  key_links:
    - from: "app/main.py"
      to: "app/core/startup.py"
      via: "lifespan calls validate_production_config"
      pattern: "validate_production_config"
    - from: "app/main.py"
      to: "app/config.py"
      via: "CORS reads settings.cors_allowed_methods"
      pattern: "settings\\.cors_allowed"
---

<objective>
Implement startup validation and CORS restriction (SEC-05, SEC-06).

Purpose: Prevent production deployments with default credentials and reduce attack surface from overly permissive CORS.
Output: Application that fails fast with clear errors if misconfigured, and CORS that explicitly whitelists HTTP methods and headers.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-security-hardening/01-RESEARCH.md

# Existing files to modify
@app/config.py
@app/main.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create startup validation module</name>
  <files>app/core/startup.py</files>
  <action>
Create new file `app/core/startup.py` with a `validate_production_config(settings)` function that:

1. Returns early (empty list) if `settings.env != "production"`
2. Checks for weak patterns in secrets: `["changeme", "default", "secret", "password", "test", "dev"]`
3. Validates these fields against weak patterns:
   - `settings.secret_key`
   - `settings.database_url`
   - `settings.elasticsearch_password`
4. Checks `settings.secret_key` length is at least 32 characters
5. Returns a list of error strings (empty if all valid)

Use lowercase comparison for weak pattern matching. Include clear error messages like:
- "SECRET_KEY contains weak/default value"
- "SECRET_KEY should be at least 32 characters"
- "DATABASE_URL contains weak/default password"

Do NOT use regex - simple `in` checks are sufficient and clearer.
  </action>
  <verify>
```bash
python -c "
from app.core.startup import validate_production_config
from app.config import Settings

# Test with production + weak secrets
class MockSettings:
    env = 'production'
    secret_key = 'changeme-bad-key'
    database_url = 'postgresql://user:changeme@localhost/db'
    elasticsearch_password = 'changeme'

errors = validate_production_config(MockSettings())
assert len(errors) >= 3, f'Expected at least 3 errors, got {len(errors)}'
print('Startup validation works correctly')
"
```
  </verify>
  <done>
validate_production_config returns errors for changeme values and short keys in production mode, returns empty list in development mode.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add CORS settings and integrate startup validation</name>
  <files>app/config.py, app/main.py</files>
  <action>
**In app/config.py:**

Add new CORS configuration fields after the existing `cors_allow_credentials` field:

```python
cors_allowed_methods: list[str] = Field(
    default=["GET", "POST", "PUT", "PATCH", "DELETE", "OPTIONS"],
    alias="CORS_ALLOWED_METHODS"
)
cors_allowed_headers: list[str] = Field(
    default=["Authorization", "Content-Type", "Accept", "Origin", "X-Requested-With"],
    alias="CORS_ALLOWED_HEADERS"
)
```

Add a `@field_validator` for `cors_allowed_methods` and `cors_allowed_headers` (mode="before") to parse comma-separated strings, similar to the existing `parse_cors_origins` validator.

**In app/main.py:**

1. Import the startup validation:
   ```python
   from app.core.startup import validate_production_config
   ```

2. In the `lifespan` function, add validation BEFORE `connect_to_db()`:
   ```python
   # Validate production configuration
   errors = validate_production_config(settings)
   if errors:
       raise RuntimeError(f"Production configuration errors: {'; '.join(errors)}")
   ```

3. Update the CORS middleware configuration to use explicit settings:
   ```python
   app.add_middleware(
       CORSMiddleware,
       allow_origins=settings.cors_origins,
       allow_credentials=settings.cors_allow_credentials,
       allow_methods=settings.cors_allowed_methods,
       allow_headers=settings.cors_allowed_headers,
       expose_headers=[
           "X-RateLimit-Limit",
           "X-RateLimit-Remaining",
           "X-RateLimit-Reset",
       ],
       max_age=600,
   )
   ```
  </action>
  <verify>
```bash
# Verify config parses correctly
python -c "
from app.config import settings
print(f'Methods: {settings.cors_allowed_methods}')
print(f'Headers: {settings.cors_allowed_headers}')
assert 'GET' in settings.cors_allowed_methods
assert 'Authorization' in settings.cors_allowed_headers
print('CORS settings OK')
"

# Verify app starts in development mode
python -c "
from app.main import app
print('App created successfully')
"
```
  </verify>
  <done>
CORS middleware uses explicit method/header lists from settings. Startup validation runs and would fail with weak secrets in production mode. App starts normally in development mode.
  </done>
</task>

</tasks>

<verification>
1. Run `python -c "from app.main import app; print('OK')"` - should succeed in dev mode
2. Temporarily set `ENV=production` with default secrets - app should fail to start with clear error
3. Check CORS headers in response: `allow_methods` should NOT be `["*"]`
</verification>

<success_criteria>
- SEC-05: Application refuses to start with changeme secrets when ENV=production
- SEC-06: CORS allows only GET, POST, PUT, PATCH, DELETE, OPTIONS methods
- SEC-06: CORS allows only Authorization, Content-Type, Accept, Origin, X-Requested-With headers
- Error messages clearly identify which configuration values are problematic
</success_criteria>

<output>
After completion, create `.planning/phases/01-security-hardening/01-01-SUMMARY.md`
</output>
